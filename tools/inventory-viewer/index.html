<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Viewer</title>
    <!--
      Inventory Viewer

      Description:
      A pure client-side tool for visualizing and exploring Ansible inventory files.
      This tool allows you to upload or paste JSON-formatted Ansible inventory data
      (typically generated using 'ansible-inventory --list'), and provides a
      hierarchical tree view of your inventory structure including groups, hosts,
      and variables.

      Features:
      - Visualize groups, hosts, and variables in a collapsible tree structure
      - Advanced search functionality with filtering by hosts, groups, or variables
      - Text highlighting of search matches for easy identification
      - Automatic expansion of parent containers to show search results
      - Shows inherited hosts and group relationships
      - No server-side processing - all data stays in your browser
      - Responsive design that works on mobile and desktop

      How to use:
      1. Export your Ansible inventory to JSON using:
         ansible-inventory -i your_inventory.ini --list > inventory.json
      2. Upload the JSON file or paste the content into this tool
      3. Browse your inventory structure using the expandable tree view
      4. Use the search functionality to find specific items:
         - Type in the search box to filter the inventory
         - Select a search type (All, Hosts, Groups, or Variables) to narrow results
         - Matching items will be highlighted and parent containers automatically expanded
         - Clear the search to return to the full view

      Privacy:
      This tool processes all data entirely in your browser. No data is sent to
      any server or stored permanently. Refreshing the page will clear all data.
    -->
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-color: #f7f9fc;
        color: #333;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }

      .nav-bar {
        background-color: #0f2b76;
        padding: 10px 0;
        color: white;
      }

      .nav-container {
        max-width: 1100px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
      }

      .nav-title {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
      }

      .nav-links a:hover {
        text-decoration: underline;
      }

      .home-icon {
        margin-right: 5px;
      }

      header {
        background-color: #1d4ed8;
        color: white;
        padding: 1.5rem 0;
        text-align: center;
        margin-bottom: 1.5rem;
        border-radius: 0;
      }

      header h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      .input-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
        transition: all 0.3s ease;
        max-height: 800px;
        overflow: visible;
        position: relative;
        z-index: 10;
      }

      .input-section.collapsed {
        max-height: 90px;
        padding: 10px 20px 30px 20px;
        cursor: pointer;
        overflow: hidden;
      }

      /* Hide input content in collapsed state but keep it in the DOM */
      .input-section.collapsed .input-content {
        display: none !important;
      }

      /* Don't hide the button group in collapsed mode */
      .input-section.collapsed .button-group {
        display: flex !important;
        margin-top: 5px;
        margin-bottom: 20px;
      }

      .input-section.collapsed .format-toggle {
        margin-bottom: 0;
      }

      /* Remove the after pseudo-element with clickable text */
      .input-section.collapsed::after {
        content: none !important;
      }

      /* Fix for collapsed state */
      .input-section.collapsed {
        max-height: 100px !important;
        padding-bottom: 40px !important;
      }

      /* Fix for buttons in collapsed state */
      .input-section.collapsed .button-group {
        margin-bottom: 20px !important;
      }

      /* Fix for "Click to expand" text */
      .input-section.collapsed::after {
        display: none !important;
      }

      .upload-area {
        border: 2px dashed #ccc;
        padding: 15px;
        text-align: center;
        margin-bottom: 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        clear: both;
      }

      .upload-area:hover {
        background-color: #f9f9f9;
      }

      .upload-area.drag-over {
        background-color: #e9f0ff;
        border-color: #1d4ed8;
      }

      .text-input {
        width: 100%;
        margin-top: 15px;
        clear: both;
      }

      textarea {
        width: 100%;
        min-height: 150px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        font-family: monospace;
        display: block;
      }

      .button-group {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        clear: both;
        width: 100%;
        position: relative;
        z-index: 20;
      }

      button {
        padding: 8px 16px;
        background-color: #1d4ed8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #1e40af;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .copy-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background-color: #4b5563;
      }

      .copy-button:hover {
        background-color: #374151;
      }

      .copy-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #10b981;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .copy-notification.show {
        opacity: 1;
        transform: translateY(0);
      }

      .search-section {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        margin-top: 20px;
        clear: both;
        position: relative;
        z-index: 5;
      }

      .search-row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .search-input {
        min-width: 300px;
        flex-grow: 1;
        max-width: 500px;
      }

      .search-input input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .search-type {
        display: none;
      }

      .search-type-dropdown {
        margin-left: 8px;
      }

      #clearSearchButton {
        display: none;
      }

      .search-input input:not(:placeholder-shown) ~ #clearSearchButton {
        display: block;
      }

      .view-controls {
        display: flex;
        gap: 5px;
        margin-left: auto;
      }

      .display-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .inventory-tree {
        font-family: monospace;
      }

      .tree-item {
        margin: 2px 0;
        padding: 3px 0;
      }

      .tree-item.highlight {
        background-color: #fffbdd;
      }

      .tree-item-header {
        cursor: pointer;
        display: flex;
        align-items: center;
        position: relative;
      }

      .download-button {
        margin-left: 10px;
        font-size: 0.85em;
        padding: 3px 8px;
        background-color: #4b5563;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: none;
        white-space: nowrap;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .tree-item-header:hover .download-button {
        display: inline-block;
      }

      .tree-item-header:hover .download-button:hover {
        background-color: #374151;
      }

      .tree-item-icon {
        margin-right: 5px;
        width: 16px;
        text-align: center;
      }

      .tree-item-content {
        margin-left: 20px;
        display: none;
      }

      .tree-item-content.expanded {
        display: block;
      }

      .tree-item-key {
        font-weight: bold;
        color: #1d4ed8;
      }

      .tree-item-value {
        color: #2a803b;
      }

      .tree-item-group {
        color: #9c4221;
        position: relative;
      }

      .tree-item-group:hover + .download-button,
      .tree-item-group:hover ~ .download-button {
        display: inline-block;
      }

      .tree-item-host {
        color: #5145cd;
        cursor: pointer;
      }

      .tree-item-host:hover {
        text-decoration: underline;
      }

      .host-ip {
        color: #6b7280;
        font-size: 0.9em;
        margin-left: 5px;
      }

      .inherited-hosts {
        color: #6b7280;
        font-style: italic;
        margin-top: 5px;
        margin-bottom: 5px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 0;
        color: #666;
      }

      .json-error {
        padding: 15px;
        background-color: #fee2e2;
        border-radius: 4px;
        color: #b91c1c;
        margin-bottom: 15px;
        display: none;
        border-left: 4px solid #b91c1c;
      }

      .format-toggle {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
      }

      .format-toggle label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
      }

      footer {
        margin-top: 30px;
        text-align: center;
        padding: 1.5rem;
        color: #4b5563;
        font-size: 0.9rem;
        border-top: 1px solid #e2e8f0;
      }

      footer a {
        color: #1d4ed8;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .search-section {
          flex-direction: column;
          align-items: stretch;
        }

        .search-options {
          flex-direction: column;
          align-items: flex-start;
        }

        button {
          min-height: 44px;
          padding: 12px 20px;
        }

        .tree-item-header {
          padding: 8px 0;
        }
      }

      /* Remove the CSS-based tooltip */
      .tree-item-host:hover::after {
        content: none;
      }

      .host-vars {
        margin-left: 24px;
      }

      /* Host vars loading spinner */
      .host-vars-loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #1d4ed8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
        vertical-align: middle;
      }

      /* Add loading indicator styles */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        flex-direction: column;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1d4ed8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      .loading-message {
        font-size: 16px;
        color: #000000;
        margin-top: 10px;
        text-align: center;
        max-width: 300px;
      }

      .loading-progress {
        width: 250px;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        margin-top: 15px;
        overflow: hidden;
        display: none;
      }

      .loading-progress-bar {
        height: 100%;
        background-color: #1d4ed8;
        width: 0%;
        transition: width 0.3s ease;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Improve accessibility for focus states */
      button:focus,
      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid #1d4ed8;
        outline-offset: 2px;
      }

      /* Improve tooltip accessibility */
      .tooltip {
        position: relative;
      }

      .tooltip-text {
        visibility: hidden;
        position: absolute;
        background: #333;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-left: 10px;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
      }

      /* Add file size warning */
      .file-size-warning {
        color: #b91c1c;
        font-size: 0.9em;
        margin-top: 5px;
        display: none;
      }

      /* Add text highlighting styles */
      .text-highlight {
        background-color: #ffff00;
        border-radius: 2px;
        padding: 0 1px;
        font-weight: bold;
        color: #000;
      }

      .tree-item.contains-match {
        background-color: #f0f8ff; /* Light blue background for items containing matches */
      }

      .download-indicator {
        display: inline-block;
        margin-left: 5px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .download-indicator:hover {
        opacity: 1;
      }
    </style>

    <!-- Fix for UI layout issues -->
    <style>
      /* Fix for buttons being cut off */
      .input-section {
        max-height: 1000px !important;
        overflow: visible !important;
        margin-bottom: 40px !important;
        padding-bottom: 40px !important;
      }

      /* Fix for collapsed state */
      .input-section.collapsed {
        max-height: 100px !important;
        padding-bottom: 40px !important;
      }

      /* Fix for buttons in collapsed state */
      .input-section.collapsed .button-group {
        margin-bottom: 20px !important;
      }

      /* Fix for "Click to expand" text */
      .input-section.collapsed::after {
        position: absolute !important;
        bottom: 10px !important;
        width: 95% !important;
        left: 2.5% !important;
      }

      /* Ensure search section doesn't overlap */
      .search-section {
        margin-top: 30px !important;
        position: relative !important;
        z-index: 5 !important;
      }

      /* Make buttons more visible */
      #loadButton,
      #clearButton,
      #shrinkButton {
        padding: 10px 16px !important;
        margin-right: 10px !important;
        font-size: 15px !important;
      }

      #loadButton {
        background-color: #2563eb !important;
        min-width: 150px !important;
        font-weight: bold !important;
      }

      /* Add space at bottom of page */
      footer {
        margin-top: 40px !important;
      }
    </style>
  </head>

  <body>
    <div class="nav-bar">
      <div class="nav-container">
        <div class="nav-title">
          <a href="../../index.html" style="color: white; text-decoration: none"
            >Tony's Tools</a
          >
        </div>
        <div class="nav-links">
          <a href="../../index.html"><span class="home-icon">🏠</span> Home</a>
          <a href="https://github.com/Get-Tony" target="_blank"
            >GitHub Profile</a
          >
          <a href="../../impressum.html">Impressum</a>
          <a href="../../privacy-policy.html">Privacy Policy</a>
        </div>
      </div>
    </div>

    <header>
      <h1>Inventory Viewer</h1>
    </header>

    <div class="container">
      <!-- Add loading overlay -->
      <div
        class="loading-overlay"
        id="loadingOverlay"
        role="alert"
        aria-busy="true"
      >
        <div class="loading-spinner" aria-label="Loading"></div>
        <div class="loading-message">Processing...</div>
        <div class="loading-progress">
          <div id="progressBar" class="loading-progress-bar"></div>
        </div>
      </div>

      <main>
        <section class="input-section" id="inputSection">
          <div class="json-error" id="jsonError" role="alert"></div>

          <div
            class="input-content"
            style="display: block; width: 100%; overflow: hidden"
          >
            <div
              class="upload-area"
              id="uploadArea"
              role="button"
              tabindex="0"
              aria-label="Upload JSON file"
            >
              <p>
                <strong
                  >Paste or upload the output of
                  <code>ansible-inventory --list</code> (JSON format)
                  here.</strong
                >
              </p>
              <ul
                style="
                  font-size: 0.9em;
                  color: #555;
                  text-align: left;
                  max-width: 600px;
                  margin: 0 auto 10px auto;
                "
              >
                <li>
                  <code
                    >ansible-inventory -i your_inventory.ini --list >
                    inventory.json</code
                  >
                </li>
                <li>
                  <code
                    >ansible-inventory -i inventory/ --list >
                    inventory.json</code
                  >
                  (for directory-based inventories)
                </li>
                <li>
                  <code
                    >ansible-inventory -i inventory_script.py --list >
                    inventory.json</code
                  >
                  (for dynamic inventories)
                </li>
              </ul>
              <p style="font-size: 0.9em; color: #555; margin-bottom: 15px">
                This tool processes all data locally in your browser - no
                information is sent to any server.
              </p>
              <input
                type="file"
                id="fileInput"
                accept=".json"
                style="display: none"
                aria-label="Choose JSON file"
              />
              <button id="browseButton" aria-label="Browse files">
                Browse Files
              </button>
              <div class="file-size-warning" id="fileSizeWarning">
                Large files may take longer to process
              </div>
            </div>

            <div class="text-input">
              <textarea
                id="jsonInput"
                placeholder="Or paste your JSON inventory data here..."
                aria-label="JSON inventory data"
              ></textarea>
            </div>
          </div>

          <div
            class="button-group"
            style="
              display: flex;
              gap: 10px;
              margin-top: 15px;
              margin-bottom: 10px;
              clear: both;
            "
          >
            <button
              id="loadButton"
              aria-label="Load inventory"
              style="
                background-color: #2563eb;
                min-width: 150px;
                font-weight: bold;
                padding: 10px 16px;
                border-radius: 4px;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 15px;
              "
              onclick="window.loadInventoryAction && window.loadInventoryAction();"
            >
              Process Inventory
            </button>
            <button
              id="clearButton"
              aria-label="Clear all data"
              style="
                background-color: #6b7280;
                padding: 10px 16px;
                border-radius: 4px;
                border: none;
                color: white;
                cursor: pointer;
              "
            >
              Clear Data
            </button>
            <button
              id="shrinkButton"
              aria-label="Shrink import area"
              style="
                background-color: #4b5563;
                min-width: 120px;
                padding: 10px 16px;
                border-radius: 4px;
                border: none;
                color: white;
                cursor: pointer;
              "
              onclick="window.shrinkImportAreaAction && window.shrinkImportAreaAction();"
            >
              Hide Input Area
            </button>
          </div>
        </section>

        <section
          class="search-section"
          id="searchSection"
          style="display: none; margin-top: 20px"
        >
          <div class="search-row">
            <div class="search-input" style="position: relative">
              <input
                type="text"
                id="searchInput"
                placeholder="Search inventory..."
                aria-label="Search inventory"
              />
              <button
                id="clearSearchButton"
                title="Clear search"
                aria-label="Clear search"
                style="
                  position: absolute;
                  right: 6px;
                  top: 50%;
                  transform: translateY(-50%);
                  background: none;
                  border: none;
                  font-size: 18px;
                  color: #888;
                  cursor: pointer;
                  display: none;
                "
              >
                &times;
              </button>
            </div>
            <div class="search-type-dropdown">
              <select
                id="searchTypeSelect"
                aria-label="Search type"
                style="
                  padding: 6px 10px;
                  font-size: 1em;
                  border-radius: 4px;
                  border: 1px solid #ccc;
                "
              >
                <option value="all">All</option>
                <option value="hosts">Hosts</option>
                <option value="groups">Groups</option>
                <option value="vars">Variables</option>
              </select>
            </div>
            <div class="view-controls">
              <button id="expandAllButton" aria-label="Expand all items">
                Expand All
              </button>
              <button id="shrinkAllButton" aria-label="Collapse all items">
                Shrink All
              </button>
              <button
                id="copyButton"
                class="copy-button"
                aria-label="Copy inventory to clipboard"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"
                  />
                  <path
                    d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"
                  />
                </svg>
                Copy JSON
              </button>
            </div>
          </div>
        </section>

        <section class="display-section">
          <div class="empty-state" id="emptyState">
            <p>No inventory loaded yet</p>
            <p>Upload a JSON file or paste JSON data above</p>
          </div>

          <div
            class="inventory-tree"
            id="inventoryTree"
            style="display: none"
          ></div>
        </section>
      </main>

      <footer>
        <p>
          Inventory Viewer - A client-side JavaScript application for Ansible
          inventory visualization
        </p>
        <div
          style="
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background-color: #f8fafc;
            max-width: 800px;
            margin: 15px auto;
            text-align: left;
          "
        >
          <p style="font-weight: bold; margin-bottom: 8px">About this tool:</p>
          <ul style="font-size: 0.9rem; padding-left: 20px; margin: 5px 0">
            <li>
              This is a standalone, single-file web application that works
              entirely in your browser
            </li>
            <li>
              All data processing happens locally - no data is transmitted to
              any server
            </li>
            <li>
              You can save this HTML file to your computer and use it offline
            </li>
            <li>
              Compatible with Ansible inventory JSON format (from
              <code>ansible-inventory --list</code>)
            </li>
            <li>
              Visualizes group hierarchies, direct and inherited hosts, and
              variables at all levels
            </li>
            <li>
              Search functionality helps find hosts, groups, or variable values
              across large inventories
            </li>
          </ul>
        </div>
        <p>
          <small>Last updated: April 27, 2025</small>
        </p>
        <p>
          <small
            >This project is licensed under the
            <a href="../../LICENSE">MIT License</a>. View the repository at
            <a
              href="https://github.com/Get-Tony/get-tony.github.io"
              target="_blank"
              >GitHub</a
            ></small
          >
        </p>
        <p>
          <small
            ><a href="../../impressum.html">Impressum</a> |
            <a href="../../privacy-policy.html">Privacy Policy</a></small
          >
        </p>
      </footer>

      <div class="copy-notification" id="copyNotification">
        Copied to clipboard!
      </div>
    </div>

    <script>
      /**
       * Inventory Viewer
       *
       * This script provides the core functionality for the Inventory Viewer.
       * It handles file uploading, JSON parsing, and rendering the inventory tree.
       * All processing happens client-side; no data is sent to any server.
       */

      // Define global functions for inline button handlers
      window.loadInventoryAction = function () {
        console.log("Global load inventory function called");
        // Get the loadInventoryFromInput function from the scope where it's defined
        var jsonInput = document.getElementById("jsonInput");
        if (jsonInput && jsonInput.value.trim()) {
          // If we have input data, try to process it
          try {
            var currentInventory = JSON.parse(jsonInput.value.trim());
            var inputSection = document.querySelector(".input-section");
            var searchSection = document.getElementById("searchSection");
            var emptyState = document.getElementById("emptyState");
            var inventoryTree = document.getElementById("inventoryTree");

            // Process and render
            if (window.renderInventory) {
              window.renderInventory(currentInventory);
              searchSection.style.display = "flex";
              emptyState.style.display = "none";
              inventoryTree.style.display = "block";
              inputSection.classList.add("collapsed");

              // Update the shrink button text
              var shrinkButton = document.getElementById("shrinkButton");
              if (shrinkButton) {
                shrinkButton.textContent = "Show Input Area";
              }
            } else {
              console.error("renderInventory function not found");
            }
          } catch (e) {
            alert("Invalid JSON format: " + e.message);
          }
        } else {
          alert("Please provide JSON inventory data");
        }
      };

      window.shrinkImportAreaAction = function () {
        console.log("Global shrink import area function called");
        const inputSection = document.querySelector(".input-section");
        const inputContent = document.querySelector(".input-content");

        if (inputSection) {
          // Hide the input content
          if (inputContent) {
            inputContent.style.display = "none";
          }

          // Then collapse the section
          inputSection.classList.add("collapsed");

          // Ensure button group is visible
          const buttonGroup = document.querySelector(".button-group");
          if (buttonGroup) {
            buttonGroup.style.display = "flex";
            buttonGroup.style.marginBottom = "15px";
          }
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        // Store public methods
        window.appLoadInventory = function () {
          if (typeof loadInventoryFromInput === "function") {
            loadInventoryFromInput();
          }
        };

        // DOM elements
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        const browseButton = document.getElementById("browseButton");
        const jsonInput = document.getElementById("jsonInput");
        const loadButton = document.getElementById("loadButton");
        const clearButton = document.getElementById("clearButton");
        const shrinkButton = document.getElementById("shrinkButton");
        const expandAllButton = document.getElementById("expandAllButton");
        const shrinkAllButton = document.getElementById("shrinkAllButton");
        const jsonError = document.getElementById("jsonError");
        const searchSection = document.getElementById("searchSection");
        const searchInput = document.getElementById("searchInput");
        const emptyState = document.getElementById("emptyState");
        const inventoryTree = document.getElementById("inventoryTree");
        const inputSection = document.querySelector(".input-section");

        // Debug check for button elements
        console.log("Load button:", loadButton);
        console.log("Shrink button:", shrinkButton);

        // Ensure buttons have distinctive styling
        if (loadButton) {
          loadButton.style.backgroundColor = "#2563eb";
          loadButton.style.fontWeight = "bold";
        } else {
          console.error("Load button not found in DOM!");
        }

        if (shrinkButton) {
          shrinkButton.style.backgroundColor = "#4b5563";
          shrinkButton.style.fontWeight = "bold";
        } else {
          console.error("Shrink button not found in DOM!");
        }

        // Current inventory data
        let currentInventory = null;

        // Add click handler to collapse/expand input section
        inputSection.addEventListener("click", function (e) {
          // Only toggle if clicking on the section itself, the collapsed message, or any non-interactive child elements
          if (
            e.target === inputSection ||
            e.target.tagName === "P" ||
            (e.target.parentNode === inputSection &&
              !e.target.classList.contains("button-group"))
          ) {
            // Check if it's an after pseudo-element click (approximate)
            const rect = inputSection.getBoundingClientRect();
            const clickY = e.clientY;
            const isLikelyClickOnAfter =
              inputSection.classList.contains("collapsed") &&
              clickY > rect.top + rect.height - 30;

            if (inputSection.classList.contains("collapsed")) {
              // Always expand on click when collapsed
              console.log("Expanding input section");
              inputSection.classList.remove("collapsed");

              // Show the input content
              const inputContent = document.querySelector(".input-content");
              if (inputContent) {
                inputContent.style.display = "block";
              }
            } else if (
              !e.target.closest(".button-group") &&
              !e.target.closest(".text-input") &&
              !e.target.closest(".upload-area")
            ) {
              // Only collapse if not clicking on an interactive element
              console.log("Collapsing input section");
              window.shrinkImportAreaAction();
            }
          }
        });

        // Prevent collapse when clicking on interactive elements
        inputSection
          .querySelectorAll("input, button, textarea, .upload-area")
          .forEach((element) => {
            element.addEventListener("click", function (e) {
              e.stopPropagation();
            });
          });

        /**
         * File Upload Handling
         *
         * The following event listeners handle file uploads via drag-and-drop
         * or file browser. Files are read as text and processed as JSON.
         */

        // Event listeners for file upload
        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.add("drag-over");
        });

        uploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.remove("drag-over");
        });

        uploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.classList.remove("drag-over");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        });

        browseButton.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change", function () {
          if (this.files.length > 0) {
            handleFileUpload(this.files[0]);
          }
        });

        /**
         * UI Helpers
         *
         * Functions to manage loading states and user feedback
         */

        // Add loading overlay functions
        function showLoading(message = "Processing...") {
          const overlay = document.getElementById("loadingOverlay");
          overlay.style.display = "flex";
          document.querySelector(".loading-message").textContent = message;
          document.querySelector(".loading-progress").style.display = "none";
        }

        function hideLoading() {
          const overlay = document.getElementById("loadingOverlay");
          overlay.style.display = "none";
          document.querySelector(".loading-progress").style.display = "none";
          document.getElementById("progressBar").style.width = "0%";
        }

        // Show loading with progress for time-consuming operations
        function showLoadingWithProgress(message = "Processing large file...") {
          document.getElementById("loadingOverlay").style.display = "flex";
          document.querySelector(".loading-message").textContent = message;
          document.querySelector(".loading-progress").style.display = "block";
          updateProgress(5); // Start with 5%
        }

        // Update progress bar
        function updateProgress(percent) {
          if (percent < 0) percent = 0;
          if (percent > 100) percent = 100;
          document.getElementById("progressBar").style.width = percent + "%";
        }

        // Add file size warning
        function checkFileSize(file) {
          const warning = document.getElementById("fileSizeWarning");
          const isLarge = file.size > 2 * 1024 * 1024; // 2MB
          if (isLarge) {
            warning.style.display = "block";
          } else {
            warning.style.display = "none";
          }
          return isLarge;
        }

        /**
         * File Processing
         *
         * Functions to read and validate file contents
         */

        // Enhance file upload handling
        function handleFileUpload(file) {
          if (
            file.type !== "application/json" &&
            !file.name.endsWith(".json")
          ) {
            showError("Please upload a JSON file");
            return;
          }

          const isLargeFile = checkFileSize(file);
          if (isLargeFile) {
            showLoadingWithProgress("Reading large file...");
          } else {
            showLoading("Reading file...");
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              // Set the value first
              jsonInput.value = e.target.result;

              // Then process the inventory in a single operation
              if (isLargeFile) {
                updateProgress(50);
                document.querySelector(".loading-message").textContent =
                  "Processing inventory...";
                updateProgress(75);
              }

              // Process the inventory immediately
              currentInventory = JSON.parse(e.target.result);
              hideError();

              // Render the inventory
              renderInventory(currentInventory);
              searchSection.style.display = "flex";
              emptyState.style.display = "none";
              inventoryTree.style.display = "block";
              inputSection.classList.add("collapsed");

              // Update shrink button text
              if (shrinkButton) {
                shrinkButton.textContent = "Show Input Area";
              }

              hideLoading();
            } catch (error) {
              showError("Error processing file: " + error.message);
              hideLoading();
            }
          };

          reader.onerror = function () {
            showError("Error reading the file");
            hideLoading();
          };

          reader.readAsText(file);
        }

        // Enhance inventory loading with error handling
        function loadInventoryFromInput(isLargeFile = false) {
          const jsonData = jsonInput.value.trim();
          if (!jsonData) {
            showError("Please provide JSON inventory data");
            return;
          }

          if (!isLargeFile) {
            showLoading("Processing inventory...");
          } else {
            document.querySelector(".loading-message").textContent =
              "Processing inventory...";
            updateProgress(85);
          }

          try {
            currentInventory = JSON.parse(jsonData);
            hideError();

            if (isLargeFile) {
              document.querySelector(".loading-message").textContent =
                "Rendering inventory...";
              updateProgress(95);
            } else {
              showLoading("Rendering inventory...");
            }

            renderInventory(currentInventory);
            searchSection.style.display = "flex";
            emptyState.style.display = "none";
            inventoryTree.style.display = "block";
            inputSection.classList.add("collapsed");

            // Update shrink button text when collapsing
            if (shrinkButton) {
              shrinkButton.textContent = "Show Input Area";
            }

            hideLoading();
          } catch (e) {
            showError("Invalid JSON format: " + e.message);
            hideLoading();
          }
        }

        // Load inventory button
        if (loadButton) {
          loadButton.onclick = function () {
            console.log("Load button clicked!");
            loadInventoryFromInput();
          };
        } else {
          console.error("Load button not found when setting up event handler");
        }

        // Clear button
        clearButton.addEventListener("click", function () {
          jsonInput.value = "";
          currentInventory = null;
          hideError();
          searchSection.style.display = "none";
          emptyState.style.display = "block";
          inventoryTree.style.display = "none";
          inventoryTree.innerHTML = "";
          searchInput.value = "";

          // Reset the file input to allow selecting the same file again
          fileInput.value = "";

          // Expand the input section when clearing
          inputSection.classList.remove("collapsed");
          // Show the input content when clearing
          const inputContent = document.querySelector(".input-content");
          if (inputContent) {
            inputContent.style.display = "block";
          }
        });

        // Shrink button
        if (shrinkButton) {
          shrinkButton.onclick = function () {
            console.log("Shrink button clicked!");
            if (inputSection.classList.contains("collapsed")) {
              // If already collapsed, expand it
              inputSection.classList.remove("collapsed");
              // Show the input content
              const inputContent = document.querySelector(".input-content");
              if (inputContent) {
                inputContent.style.display = "block";
              }
              // Change button text
              this.textContent = "Hide Input Area";
            } else {
              // If expanded, collapse it
              inputSection.classList.add("collapsed");
              // Change button text
              this.textContent = "Show Input Area";
            }
          };
        } else {
          console.error(
            "Shrink button not found when setting up event handler"
          );
        }

        /**
         * Tree Expansion Controls
         *
         * Functions to expand or collapse all tree nodes
         */

        // Expand All button
        expandAllButton.addEventListener("click", function () {
          if (!currentInventory) return;

          const allExpandableItems =
            inventoryTree.querySelectorAll(".tree-item-content");
          allExpandableItems.forEach((content) => {
            content.classList.add("expanded");
            const icon = content.parentElement.querySelector(".tree-item-icon");
            if (icon) icon.textContent = "▼";
            // If this is a host node, render host vars
            const parent = content.parentElement;
            if (
              parent &&
              parent.getAttribute("data-type") === "host" &&
              typeof parent.expandHostNode === "function"
            ) {
              parent.expandHostNode();
            }
          });
        });

        // Shrink All button
        shrinkAllButton.addEventListener("click", function () {
          if (!currentInventory) return;

          const allExpandableItems =
            inventoryTree.querySelectorAll(".tree-item-content");
          allExpandableItems.forEach((content) => {
            content.classList.remove("expanded");
            const icon = content.parentElement.querySelector(".tree-item-icon");
            if (icon) icon.textContent = "▶";
          });
        });

        /**
         * Search Functionality
         *
         * Event listeners and functions for searching the inventory
         */

        // Search functionality
        searchInput.addEventListener("input", function () {
          document.getElementById("clearSearchButton").style.display = this
            .value
            ? "block"
            : "none";
          if (currentInventory) {
            const searchTerm = this.value.toLowerCase();
            const searchType =
              document.getElementById("searchTypeSelect").value;

            // If searching for variables, expand all host nodes first
            if (searchTerm && (searchType === "all" || searchType === "vars")) {
              // Expand host nodes to make their variables searchable
              expandHostNodesForSearch();
            }

            filterInventory(searchTerm, searchType);
          }
        });

        document
          .getElementById("searchTypeSelect")
          .addEventListener("change", function () {
            const searchTerm = searchInput.value.toLowerCase();
            const searchType = this.value;

            // If searching for variables, expand all host nodes first
            if (searchTerm && (searchType === "all" || searchType === "vars")) {
              // Expand host nodes to make their variables searchable
              expandHostNodesForSearch();
            }

            filterInventory(searchTerm, searchType);
          });

        // Helper function to expand host nodes for searching variables
        function expandHostNodesForSearch() {
          // Expand all host nodes to make their variables searchable
          const allHostItems = inventoryTree.querySelectorAll(
            '.tree-item[data-type="host"]'
          );

          allHostItems.forEach((item) => {
            // Only expand if not already expanded
            const content = item.querySelector(".tree-item-content");
            if (content && !content.classList.contains("expanded")) {
              if (typeof item.expandHostNode === "function") {
                item.expandHostNode();
              }
            }
          });
        }

        document
          .getElementById("clearSearchButton")
          .addEventListener("click", function (e) {
            searchInput.value = "";
            this.style.display = "none";
            if (currentInventory) {
              filterInventory(
                "",
                document.getElementById("searchTypeSelect").value
              );
            }
            searchInput.focus();
            e.preventDefault();
          });

        /**
         * Error Handling
         *
         * Functions to show and hide error messages
         */

        // Show error message
        function showError(message) {
          jsonError.textContent = message;
          jsonError.style.display = "block";
        }

        // Hide error message
        function hideError() {
          jsonError.style.display = "none";
        }

        /**
         * Inventory Data Helpers
         *
         * Functions to process and analyze the Ansible inventory structure
         */

        // Get all hosts for a group recursively
        function getAllGroupHosts(groupName, inventory, visited = new Set()) {
          if (visited.has(groupName)) return []; // Prevent circular references
          visited.add(groupName);

          const group = inventory[groupName];
          if (!group) return [];

          let allHosts = [];

          // Add direct hosts
          if (group.hosts && Array.isArray(group.hosts)) {
            allHosts = [...group.hosts];
          }

          // Add hosts from children
          if (group.children && Array.isArray(group.children)) {
            for (const childName of group.children) {
              const childHosts = getAllGroupHosts(
                childName,
                inventory,
                new Set([...visited])
              );
              allHosts = [...allHosts, ...childHosts];
            }
          }

          return allHosts;
        }

        // Helper to find all child groups recursively
        function getAllChildGroups(groupName, inventory, visited = new Set()) {
          if (visited.has(groupName)) return [];
          visited.add(groupName);
          const group = inventory[groupName];
          if (!group || !group.children) return [];
          let allChildren = [...group.children];
          for (const child of group.children) {
            allChildren = [
              ...allChildren,
              ...getAllChildGroups(child, inventory, visited),
            ];
          }
          return allChildren;
        }

        // Helper to find top-level groups (not children of any other group, and not 'all')
        function getTopLevelGroups(inventory) {
          const allGroups = Object.keys(inventory).filter(
            (key) => key !== "_meta" && key !== "all"
          );
          const childGroups = new Set();
          for (const groupName of allGroups) {
            const group = inventory[groupName];
            if (group && group.children) {
              group.children.forEach((child) => childGroups.add(child));
            }
          }
          return allGroups.filter((g) => !childGroups.has(g));
        }

        // Helper to get inherited hosts for a group (from all child groups, not direct)
        function getInheritedHosts(groupName, inventory) {
          const group = inventory[groupName];
          if (!group || !group.children) return [];
          let inherited = [];
          for (const child of group.children) {
            // Get all hosts for this child (direct and inherited)
            const childHosts = getAllGroupHosts(child, inventory);
            // Remove hosts that are direct in this group
            const directHosts = group.hosts || [];
            for (const host of childHosts) {
              if (!directHosts.includes(host)) {
                inherited.push({ host, from: child });
              }
            }
          }
          return inherited;
        }

        /**
         * Inventory Rendering
         *
         * Functions to build and render the inventory tree visualization
         */

        // Render inventory data
        function renderInventory(data) {
          inventoryTree.innerHTML = "";
          if (data && typeof data === "object") {
            // Process all variables first to ensure they're available during search
            preprocessInventoryData(data);

            if (data._meta) {
              renderMetadata(data._meta);
            }
            // Always render 'all' group if present
            if (data.all) {
              const allGroup = createTreeItem("all", "group", true);
              inventoryTree.appendChild(allGroup);
              const allContent = allGroup.querySelector(".tree-item-content");
              // Render vars if present
              if (data.all.vars && Object.keys(data.all.vars).length > 0) {
                const varsItem = createTreeItem("vars", "subsection", true);
                allContent.appendChild(varsItem);
                const varsContent =
                  varsItem.querySelector(".tree-item-content");
                renderVariables(data.all.vars, varsContent);
              }
              // Render children if present
              if (
                data.all.children &&
                Array.isArray(data.all.children) &&
                data.all.children.length > 0
              ) {
                const childrenItem = createTreeItem(
                  "children",
                  "subsection",
                  true
                );
                allContent.appendChild(childrenItem);
                const childrenContent =
                  childrenItem.querySelector(".tree-item-content");
                data.all.children.forEach((childName) => {
                  if (data[childName]) {
                    renderGroup(childName, data, childrenContent);
                  }
                });
              }
            }
            const groupsSection = createTreeItem("Groups", "section", true);
            inventoryTree.appendChild(groupsSection);
            const groupsContent =
              groupsSection.querySelector(".tree-item-content");
            // Only render top-level groups
            const topGroups = getTopLevelGroups(data);
            topGroups.sort().forEach((groupName) => {
              renderGroup(groupName, data, groupsContent);
            });
          } else {
            showError("Invalid inventory format");
          }
        }

        // Preprocess inventory data to ensure all variables are accessible for search
        function preprocessInventoryData(data) {
          // Process all host variables to make them accessible
          if (data && data._meta && data._meta.hostvars) {
            // Ensure all host variables include any relevant 'all' group variables
            if (data.all && data.all.vars) {
              // Loop through all hosts and ensure they have the 'all' vars
              Object.keys(data._meta.hostvars).forEach((hostname) => {
                let hostVars = data._meta.hostvars[hostname];
                if (!hostVars) {
                  data._meta.hostvars[hostname] = {};
                  hostVars = data._meta.hostvars[hostname];
                }

                // Apply 'all' variables as defaults if they don't exist in the host vars
                Object.keys(data.all.vars).forEach((varName) => {
                  if (hostVars[varName] === undefined) {
                    hostVars[varName] = data.all.vars[varName];
                  }
                });
              });
            }
          }
        }

        // Make renderInventory available globally
        window.renderInventory = renderInventory;

        /**
         * Render a group with direct and inherited hosts, and child groups
         *
         * This function recursively builds the tree structure for a group,
         * showing its direct hosts, inherited hosts, child groups, and variables.
         */
        function renderGroup(groupName, inventory, container) {
          const group = inventory[groupName];
          if (!group) return;
          const groupItem = createTreeItem(groupName, "group", true);
          container.appendChild(groupItem);
          const groupContent = groupItem.querySelector(".tree-item-content");
          // Direct hosts
          const directHosts = group.hosts || [];
          if (directHosts.length > 0) {
            const hostsItem = createTreeItem(
              "Direct Hosts",
              "subsection",
              true
            );
            groupContent.appendChild(hostsItem);
            const hostsContent = hostsItem.querySelector(".tree-item-content");
            directHosts.forEach((host) => {
              let ipAddress = "";
              if (
                inventory._meta &&
                inventory._meta.hostvars &&
                inventory._meta.hostvars[host]
              ) {
                ipAddress = inventory._meta.hostvars[host].ansible_host || "";
              }
              const hostItem = createHostItem(host, ipAddress);
              hostsContent.appendChild(hostItem);
            });
          }
          // Inherited hosts
          const inheritedHosts = getInheritedHosts(groupName, inventory);
          if (inheritedHosts.length > 0) {
            const inhItem = createTreeItem(
              "Inherited Hosts",
              "subsection",
              true
            );
            groupContent.appendChild(inhItem);
            const inhContent = inhItem.querySelector(".tree-item-content");
            inheritedHosts.forEach(({ host, from }) => {
              let ipAddress = "";
              if (
                inventory._meta &&
                inventory._meta.hostvars &&
                inventory._meta.hostvars[host]
              ) {
                ipAddress = inventory._meta.hostvars[host].ansible_host || "";
              }
              const hostItem = createHostItem(host, ipAddress, from);
              inhContent.appendChild(hostItem);
            });
          }
          // Child groups (no 'children' label)
          if (
            group.children &&
            Array.isArray(group.children) &&
            group.children.length > 0
          ) {
            group.children.sort().forEach((childName) => {
              renderGroup(childName, inventory, groupContent);
            });
          }
          // Group vars
          if (group.vars && typeof group.vars === "object") {
            const varsItem = createTreeItem("vars", "subsection", true);
            groupContent.appendChild(varsItem);
            const varsContent = varsItem.querySelector(".tree-item-content");
            renderVariables(group.vars, varsContent);
          }
        }

        /**
         * Create host item with IP address and optional source group display
         *
         * This function creates a tree node for a host, including expandable
         * section for host variables. It also handles keyboard accessibility.
         */
        function createHostItem(hostname, ipAddress, sourceGroup = "") {
          const item = document.createElement("div");
          item.className = "tree-item tooltip";
          item.setAttribute("data-label", hostname.toLowerCase());
          item.setAttribute("data-type", "host");
          item.setAttribute("data-hostname", hostname);

          const header = document.createElement("div");
          header.className = "tree-item-header";
          header.setAttribute("role", "button");
          header.setAttribute("tabindex", "0");
          header.setAttribute(
            "aria-label",
            `Host ${hostname}${ipAddress ? ` (${ipAddress})` : ""}`
          );

          let displayHTML = `
            <span class="tree-item-icon" aria-hidden="true">▶</span>
            <span class="tree-item-host">${escapeHtml(hostname)}</span>
          `;

          if (ipAddress) {
            displayHTML += `<span class="host-ip">(${escapeHtml(
              ipAddress
            )})</span>`;
          }

          if (sourceGroup) {
            displayHTML += `<span class="host-ip"> - inherited from ${escapeHtml(
              sourceGroup
            )}</span>`;
          }

          // Add accessible tooltip
          displayHTML += `<span class="tooltip-text">Click to view host variables</span>`;

          header.innerHTML = displayHTML;
          item.appendChild(header);

          // Add content container for variables
          const content = document.createElement("div");
          content.className = "tree-item-content";
          item.appendChild(content);

          // Pre-render host vars but keep them hidden initially
          if (
            currentInventory &&
            currentInventory._meta &&
            currentInventory._meta.hostvars &&
            currentInventory._meta.hostvars[hostname]
          ) {
            const hostVars = currentInventory._meta.hostvars[hostname];
            const varLabel = document.createElement("div");
            varLabel.className = "tree-item host-vars";
            varLabel.innerHTML = `<span class="tree-item-key">Host Variables</span>`;
            content.appendChild(varLabel);
            // Indent all host variables
            const varsContainer = document.createElement("div");
            varsContainer.className = "host-vars";
            content.appendChild(varsContainer);
            renderVariables(hostVars, varsContainer);
          }

          // Helper to render host variables
          function renderHostVars() {
            // Only load vars if they haven't been loaded yet
            if (content.childElementCount === 0) {
              // Show loading indicator
              content.innerHTML = `<div class="tree-item host-vars">
                <span class="tree-item-key">Loading variables</span>
                <span class="host-vars-loading" aria-label="Loading variables"></span>
              </div>`;

              // Use setTimeout to allow the UI to update before processing
              setTimeout(() => {
                content.innerHTML = "";
                if (
                  currentInventory &&
                  currentInventory._meta &&
                  currentInventory._meta.hostvars &&
                  currentInventory._meta.hostvars[hostname]
                ) {
                  const hostVars = currentInventory._meta.hostvars[hostname];
                  const varLabel = document.createElement("div");
                  varLabel.className = "tree-item host-vars";
                  varLabel.innerHTML = `<span class="tree-item-key">Host Variables</span>`;
                  content.appendChild(varLabel);
                  // Indent all host variables
                  const varsContainer = document.createElement("div");
                  varsContainer.className = "host-vars";
                  content.appendChild(varsContainer);
                  renderVariables(hostVars, varsContainer);
                }
              }, 10);
            }
          }

          // Shared function to expand host node and render vars
          function expandHostNode() {
            // Only render if not already rendered
            if (content.childElementCount === 0) {
              renderHostVars();
            }
            content.classList.add("expanded");
            const icon = header.querySelector(".tree-item-icon");
            if (icon) icon.textContent = "▼";
          }

          // Add click handler for hosts
          header.addEventListener("click", function (e) {
            const icon = this.querySelector(".tree-item-icon");
            if (content.classList.contains("expanded")) {
              content.classList.remove("expanded");
              icon.textContent = "▶";
            } else {
              expandHostNode();
            }
          });

          // Expose expandHostNode for Expand All logic
          item.expandHostNode = expandHostNode;

          // Add keyboard support
          header.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              this.click();
            }
          });

          return item;
        }

        /**
         * Load host variables dynamically
         *
         * Retrieves and renders host-specific variables when a host node is expanded.
         */
        function loadHostVariables(hostname, container) {
          // Clear existing content
          container.innerHTML = "";

          // Check if host variables exist in the inventory
          if (
            currentInventory &&
            currentInventory._meta &&
            currentInventory._meta.hostvars &&
            currentInventory._meta.hostvars[hostname]
          ) {
            const hostVars = currentInventory._meta.hostvars[hostname];

            // Add a label for host variables
            const varLabel = document.createElement("div");
            varLabel.className = "tree-item";
            varLabel.innerHTML = `<span class="tree-item-key">Host Variables</span>`;
            container.appendChild(varLabel);

            // Render the variables
            renderVariables(hostVars, container);
          } else {
            // No variables found
            const noVars = document.createElement("div");
            noVars.className = "tree-item";
            noVars.innerHTML =
              '<span class="tree-item-value">No variables found for this host</span>';
            container.appendChild(noVars);
          }
        }

        /**
         * Render metadata section
         *
         * Creates a section with inventory metadata like total host count.
         */
        function renderMetadata(meta) {
          if (!meta) return;

          const metaSection = createTreeItem(
            "Inventory Metadata",
            "section",
            true
          );
          inventoryTree.appendChild(metaSection);

          const metaContent = metaSection.querySelector(".tree-item-content");

          // Count all unique hosts across all groups
          const allHosts = new Set();
          function collectHosts(inventory) {
            for (const [key, value] of Object.entries(inventory)) {
              if (key === "_meta") continue;
              if (value.hosts && Array.isArray(value.hosts)) {
                value.hosts.forEach((host) => allHosts.add(host));
              }
              if (value.children && Array.isArray(value.children)) {
                value.children.forEach((child) => {
                  if (inventory[child]) {
                    collectHosts({ [child]: inventory[child] });
                  }
                });
              }
            }
          }
          collectHosts(currentInventory);

          // Add hosts count
          const metaInfo = document.createElement("div");
          metaInfo.className = "tree-item";
          metaInfo.innerHTML = `<span class="tree-item-key">Total Hosts</span>: <span class="tree-item-value">${allHosts.size}</span>`;
          metaContent.appendChild(metaInfo);

          // Add timestamp
          const timestamp = new Date().toISOString();
          const timeInfo = document.createElement("div");
          timeInfo.className = "tree-item";
          timeInfo.innerHTML = `<span class="tree-item-key">Loaded At</span>: <span class="tree-item-value">${timestamp}</span>`;
          metaContent.appendChild(timeInfo);
        }

        /**
         * Render variables recursively
         *
         * Creates expandable tree items for complex variables (objects/arrays)
         * and simple key-value pairs for primitive values.
         */
        function renderVariables(vars, container) {
          if (!vars || typeof vars !== "object") return;

          Object.keys(vars)
            .sort()
            .forEach((varName) => {
              const varValue = vars[varName];

              if (typeof varValue === "object" && varValue !== null) {
                const objItem = createTreeItem(varName, "variable", true);
                container.appendChild(objItem);
                const objContent = objItem.querySelector(".tree-item-content");
                renderVariables(varValue, objContent);
              } else {
                const valItem = document.createElement("div");
                valItem.className = "tree-item";
                valItem.innerHTML = `<span class="tree-item-key">${escapeHtml(
                  varName
                )}</span>: <span class="tree-item-value">${escapeHtml(
                  JSON.stringify(varValue)
                )}</span>`;
                container.appendChild(valItem);
              }
            });
        }

        /**
         * Create tree item element
         *
         * Core function to create expandable/collapsible tree nodes
         * with proper accessibility attributes and event handlers.
         */
        function createTreeItem(label, type, expandable = false) {
          const item = document.createElement("div");
          item.className = "tree-item";
          item.setAttribute("data-label", label.toLowerCase());
          item.setAttribute("data-type", type);

          let labelClass = "";
          switch (type) {
            case "group":
              labelClass = "tree-item-group";
              break;
            case "host":
              labelClass = "tree-item-host";
              break;
            case "variable":
              labelClass = "tree-item-key";
              break;
          }

          const header = document.createElement("div");
          header.className = "tree-item-header";

          if (expandable) {
            header.innerHTML = `
                <span class="tree-item-icon">▶</span>
                <span class="${labelClass}">${escapeHtml(label)}</span>
            `;

            // For groups, add download button
            if (type === "group") {
              const downloadButton = document.createElement("button");
              downloadButton.className = "download-button";
              downloadButton.textContent = "Download Group";
              downloadButton.setAttribute(
                "aria-label",
                `Download ${label} group as JSON`
              );
              downloadButton.setAttribute(
                "title",
                `Download ${label} group as JSON`
              );
              downloadButton.addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent toggling group expansion
                downloadGroupAsJson(label);
              });
              header.appendChild(downloadButton);

              // Add a more visible download indicator next to the group name
              const groupNameElement = header.querySelector(`.${labelClass}`);
              if (groupNameElement) {
                const downloadIndicator = document.createElement("span");
                downloadIndicator.className = "download-indicator";
                downloadIndicator.innerHTML =
                  " <span title='Download this group as JSON' style='font-size: 0.8em; color: #4b5563;'>⬇️</span>";
                downloadIndicator.addEventListener("click", function (e) {
                  e.stopPropagation(); // Prevent toggling group expansion
                  downloadGroupAsJson(label);
                });
                groupNameElement.appendChild(downloadIndicator);
              }
            }

            header.addEventListener("click", function () {
              const content = item.querySelector(".tree-item-content");
              const icon = this.querySelector(".tree-item-icon");

              if (content.classList.contains("expanded")) {
                content.classList.remove("expanded");
                icon.textContent = "▶";
              } else {
                content.classList.add("expanded");
                icon.textContent = "▼";
              }
            });
          } else {
            header.innerHTML = `
                <span class="tree-item-icon"></span>
                <span class="${labelClass}">${escapeHtml(label)}</span>
            `;
          }

          item.appendChild(header);

          if (expandable) {
            const content = document.createElement("div");
            content.className = "tree-item-content";
            item.appendChild(content);
          }

          return item;
        }

        /**
         * Filter inventory based on search
         *
         * Searches through the inventory tree for items matching the search term,
         * and shows only matching items (and their parent containers).
         */
        function filterInventory(searchTerm, searchType) {
          const allItems = inventoryTree.querySelectorAll(".tree-item");

          if (!searchTerm) {
            // Reset all items and remove highlights
            allItems.forEach((item) => {
              item.style.display = "";
              item.classList.remove("highlight");
              item.classList.remove("contains-match");
            });

            // Remove text highlights
            const highlightedText =
              inventoryTree.querySelectorAll(".text-highlight");
            highlightedText.forEach((el) => {
              const parent = el.parentNode;
              parent.replaceChild(document.createTextNode(el.textContent), el);
              // Normalize to combine adjacent text nodes
              parent.normalize();
            });

            // Close all expanded items except top-level sections
            inventoryTree
              .querySelectorAll(
                '.tree-item:not([data-type="section"]) .tree-item-content.expanded'
              )
              .forEach((content) => {
                content.classList.remove("expanded");
                const icon =
                  content.parentElement.querySelector(".tree-item-icon");
                if (icon) icon.textContent = "▶";
              });

            return;
          }

          // First make all items visible to ensure proper search
          allItems.forEach((item) => {
            item.style.display = "";
            item.classList.remove("highlight");
            item.classList.remove("contains-match");
          });

          // Remove existing highlights first
          const existingHighlights =
            inventoryTree.querySelectorAll(".text-highlight");
          existingHighlights.forEach((el) => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
          });

          // Search based on type
          let matchedItems = [];

          if (searchType === "all" || searchType === "hosts") {
            // Search hosts
            const hostItems = inventoryTree.querySelectorAll(
              '.tree-item[data-type="host"]'
            );
            hostItems.forEach((item) => {
              const label = item.getAttribute("data-label");
              const hostText = item.textContent.toLowerCase();
              if (label.includes(searchTerm) || hostText.includes(searchTerm)) {
                matchedItems.push(item);
                // Highlight the hostname directly
                const hostnameElement = item.querySelector(".tree-item-host");
                if (hostnameElement) {
                  highlightTextInElement(hostnameElement, searchTerm);
                }
              }
            });
          }

          if (searchType === "all" || searchType === "groups") {
            // Search groups
            const groupItems = inventoryTree.querySelectorAll(
              '.tree-item[data-type="group"]'
            );
            groupItems.forEach((item) => {
              const label = item.getAttribute("data-label");
              if (label.includes(searchTerm)) {
                matchedItems.push(item);
                // Highlight the group name
                const groupElement = item.querySelector(".tree-item-group");
                if (groupElement) {
                  highlightTextInElement(groupElement, searchTerm);
                }
              }
            });
          }

          if (searchType === "all" || searchType === "vars") {
            // Search variables - look for keys and values separately
            const keyItems = inventoryTree.querySelectorAll(".tree-item-key");
            keyItems.forEach((item) => {
              if (item.textContent.toLowerCase().includes(searchTerm)) {
                const treeItem = item.closest(".tree-item");
                if (treeItem && !matchedItems.includes(treeItem)) {
                  matchedItems.push(treeItem);
                }
                highlightTextInElement(item, searchTerm);
              }
            });

            const valueItems =
              inventoryTree.querySelectorAll(".tree-item-value");
            valueItems.forEach((item) => {
              if (item.textContent.toLowerCase().includes(searchTerm)) {
                const treeItem = item.closest(".tree-item");
                if (treeItem && !matchedItems.includes(treeItem)) {
                  matchedItems.push(treeItem);
                }
                highlightTextInElement(item, searchTerm);
              }
            });
          }

          // Hide non-matched items
          if (matchedItems.length > 0) {
            allItems.forEach((item) => {
              item.style.display = "none";
            });

            // Show matched items and their parents
            matchedItems.forEach((item) => {
              item.classList.add("contains-match");
              showItemAndParents(item);

              // Expand parent containers
              let parent = item.parentElement;
              while (parent) {
                if (parent.classList.contains("tree-item-content")) {
                  parent.classList.add("expanded");
                  const header =
                    parent.parentElement.querySelector(".tree-item-header");
                  if (header) {
                    const icon = header.querySelector(".tree-item-icon");
                    if (icon) icon.textContent = "▼";
                  }
                }
                parent = parent.parentElement;
              }
            });
          }
        }

        /**
         * Show item and all its parent containers
         *
         * Helper function for the search feature to ensure parent
         * elements are visible when a child matches the search.
         */
        function showItemAndParents(item) {
          item.style.display = "";

          let parent = item.parentElement;
          while (parent) {
            if (
              parent.classList.contains("tree-item") ||
              parent.classList.contains("tree-item-content")
            ) {
              parent.style.display = "";

              // If this is a tree-item-content, make sure its parent item is also visible
              if (parent.classList.contains("tree-item-content")) {
                const parentItem = parent.parentElement;
                if (parentItem) {
                  parentItem.style.display = "";
                }
              }
            }
            parent = parent.parentElement;
          }
        }

        /**
         * Helper to escape HTML
         *
         * Security function to prevent XSS by escaping special characters.
         */
        function escapeHtml(unsafe) {
          if (typeof unsafe !== "string") {
            return unsafe;
          }
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        /**
         * Copy to Clipboard
         *
         * Function to copy the inventory JSON to clipboard
         */
        const copyButton = document.getElementById("copyButton");
        const copyNotification = document.getElementById("copyNotification");

        copyButton.addEventListener("click", function () {
          if (!currentInventory) return;

          const json = JSON.stringify(currentInventory, null, 2);

          // Use modern Clipboard API with fallback
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(json)
              .then(() => {
                showCopyNotification();
              })
              .catch((err) => {
                console.error("Could not copy text: ", err);
                // Fallback to the old method
                fallbackCopy(json);
              });
          } else {
            // Fallback for browsers that don't support the Clipboard API
            fallbackCopy(json);
          }
        });

        function fallbackCopy(text) {
          // Create a temporary textarea element
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.setAttribute("readonly", "");
          textarea.style.position = "absolute";
          textarea.style.left = "-9999px";
          document.body.appendChild(textarea);

          // Select and copy the text
          textarea.select();
          document.execCommand("copy");

          // Remove the textarea
          document.body.removeChild(textarea);

          showCopyNotification();
        }

        function showCopyNotification() {
          copyNotification.classList.add("show");
          setTimeout(function () {
            copyNotification.classList.remove("show");
          }, 2000);
        }

        /**
         * Download Group as JSON
         *
         * Extract a specific group from the inventory and download it as a JSON file
         */
        function downloadGroupAsJson(groupName) {
          if (!currentInventory || !currentInventory[groupName]) return;

          // Create a subset of the inventory with just this group and needed metadata
          const subset = {
            [groupName]: JSON.parse(
              JSON.stringify(currentInventory[groupName])
            ),
          };

          // Convert to JSON string
          const json = JSON.stringify(subset, null, 2);

          // Create and trigger download
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${groupName}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // Helper function to highlight text matches within an element
        function highlightTextInElement(element, searchTerm) {
          if (!element || !element.textContent) return;

          const text = element.textContent;
          const lowerText = text.toLowerCase();
          const lowerSearchTerm = searchTerm.toLowerCase();

          // If no match, return
          if (!lowerText.includes(lowerSearchTerm)) return;

          // Clear existing content
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }

          let currentIndex = 0;
          let match;

          // Find all instances of searchTerm in the text (case-insensitive)
          while (
            (match = lowerText.indexOf(lowerSearchTerm, currentIndex)) !== -1
          ) {
            // Add text before the match
            if (match > currentIndex) {
              element.appendChild(
                document.createTextNode(text.substring(currentIndex, match))
              );
            }

            // Add highlighted match
            const highlightSpan = document.createElement("span");
            highlightSpan.className = "text-highlight";
            highlightSpan.textContent = text.substring(
              match,
              match + searchTerm.length
            );
            element.appendChild(highlightSpan);

            // Update index for next iteration
            currentIndex = match + searchTerm.length;
          }

          // Add any remaining text
          if (currentIndex < text.length) {
            element.appendChild(
              document.createTextNode(text.substring(currentIndex))
            );
          }
        }
      });
    </script>
  </body>
</html>
